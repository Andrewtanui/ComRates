@model IEnumerable<TanuiApp.Models.CartItem>
@using Microsoft.AspNetCore.Identity
@inject UserManager<TanuiApp.Models.Users> UserManager
@{
    ViewData["Title"] = "Checkout";
    var grandTotal = Model.Sum(i => i.Product.Price * i.Quantity);
    var deliveryServices = ViewBag.DeliveryServices as List<TanuiApp.Models.Users> ?? new List<TanuiApp.Models.Users>();
    var currentUser = await UserManager.GetUserAsync(User);
}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="bi bi-credit-card me-2"></i> Checkout</h3>
                </div>
                <div class="card-body">
                    <h5 class="mb-4">Review Your Cart</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.Product.Name</td>
                                    <td>KSh. @item.Product.Price.ToString("N0")</td>
                                    <td>@item.Quantity</td>
                                    <td class="fw-bold">KSh. @((item.Product.Price * item.Quantity).ToString("N0"))</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="fw-bold bg-light">
                                <td colspan="3" class="text-end">Grand Total:</td>
                                <td class="text-success fs-5">KSh. @grandTotal.ToString("N0")</td>
                            </tr>
                        </tfoot>
                    </table>
                    <hr />
                    
                    <h5 class="mb-3"><i class="bi bi-truck me-2"></i>Delivery Information</h5>
                    <form asp-action="PlaceOrder" method="post" id="checkoutForm">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Delivery Address</label>
                                <input type="text" name="deliveryAddress" class="form-control" value="@(currentUser?.Address)" required />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Town/City</label>
                                <input type="text" name="deliveryTown" class="form-control" value="@(currentUser?.Town)" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">County</label>
                                <input type="text" name="deliveryCounty" class="form-control" value="@(currentUser?.County)" required />
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Select Delivery Service</label>
                            <select name="deliveryServiceId" class="form-select" id="deliveryServiceSelect" required>
                                <option value="">-- Choose a delivery service --</option>
                                @foreach (var service in deliveryServices)
                                {
                                    <option value="@service.Id" data-fee="@(new Random().Next(100, 500))">
                                        @service.CompanyName - @service.Town (@service.County)
                                    </option>
                                }
                            </select>
                            <div class="form-text">Delivery fee will be calculated based on your location</div>
                        </div>
                        
                        <div class="alert alert-info mb-3" id="deliveryFeeInfo" style="display:none;">
                            <strong>Delivery Fee:</strong> <span id="deliveryFeeAmount">KSh. 0</span>
                        </div>
                        
                        <hr />
                        <h5 class="mb-3"><i class="bi bi-credit-card me-2"></i>Payment Method</h5>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select name="paymentMethod" class="form-select" required>
                                <option value="Mpesa">M-Pesa</option>
                                <option value="CashOnDelivery">Cash on Delivery</option>
                            </select>
                        </div>
                        
                        <div class="card bg-light p-3 mb-3">
                            <h6 class="mb-2">Order Summary</h6>
                            <div class="d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span>KSh. @grandTotal.ToString("N0")</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Delivery Fee:</span>
                                <span id="summaryDeliveryFee">KSh. 0</span>
                            </div>
                            <hr />
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Total:</span>
                                <span class="text-success" id="grandTotal">KSh. @grandTotal.ToString("N0")</span>
                            </div>
                        </div>
                        
                        <input type="hidden" name="deliveryFee" id="deliveryFeeInput" value="0" />
                        <button type="submit" class="btn btn-success btn-lg w-100">
                        </button>
                        @Html.AntiForgeryToken()
                    </form>
                    
                    <div class="mt-3 text-center">
                        <a asp-controller="Cart" asp-action="MyCart" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Cart
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const subtotal = @grandTotal;
        const deliverySelect = document.getElementById('deliveryServiceSelect');
        const deliveryFeeInfo = document.getElementById('deliveryFeeInfo');
        const deliveryFeeAmount = document.getElementById('deliveryFeeAmount');
        const summaryDeliveryFee = document.getElementById('summaryDeliveryFee');
        const grandTotalElement = document.getElementById('grandTotal');
        const deliveryFeeInput = document.getElementById('deliveryFeeInput');
        
        deliverySelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const fee = selectedOption.getAttribute('data-fee') || 0;
            const feeNum = parseFloat(fee);
            
            if (feeNum > 0) {
                deliveryFeeInfo.style.display = 'block';
                deliveryFeeAmount.textContent = 'KSh. ' + feeNum.toLocaleString();
                summaryDeliveryFee.textContent = 'KSh. ' + feeNum.toLocaleString();
                deliveryFeeInput.value = feeNum;
                
                const total = subtotal + feeNum;
                grandTotalElement.textContent = 'KSh. ' + total.toLocaleString();
            } else {
                deliveryFeeInfo.style.display = 'none';
                deliveryFeeAmount.textContent = 'KSh. 0';
                summaryDeliveryFee.textContent = 'KSh. 0';
                deliveryFeeInput.value = 0;
                grandTotalElement.textContent = 'KSh. ' + subtotal.toLocaleString();
            }
        });
    </script>
}